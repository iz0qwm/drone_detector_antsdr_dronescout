<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CRPC Dashboard</title>
<style>
  :root{ --bg:#0e1117; --card:#161b22; --muted:#8b949e; --text:#e6edf3; --ok:#2ea043; --bad:#da3633; --warn:#d29922; --chip:#30363d; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid #30363d}
  h1{font-size:18px;margin:0}
  .grid{display:grid;gap:12px;padding:12px}
  .cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width: 1100px){.cols-3{grid-template-columns:1fr}.cols-2{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid #30363d;border-radius:14px;padding:12px}
  .card h2{font-size:15px;margin:0 0 8px 0}
  .kpi{display:flex;gap:10px;flex-wrap:wrap}
  .chip{background:var(--chip);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
  .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{padding:6px 8px;border-bottom:1px solid #30363d;vertical-align:top}
  th{color:var(--muted);text-align:left;font-weight:600}
  code, pre{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .row{display:flex;gap:12px;align-items:stretch}
  .grow{flex:1}
  .muted{color:var(--muted)}
  .right{float:right}
  .spark{height:36px;width:100%}
  .svc{display:grid;grid-template-columns:160px auto;gap:8px;align-items:center;margin:4px 0}
  .tabbar{display:flex;gap:8px;padding:0 12px;flex-wrap:wrap}
  .tabbar button{background:var(--chip);border:1px solid #30363d;color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer}
  .tabbar button.active{outline:2px solid #58a6ff}
  .tab{display:none}
  .tab.active{display:block}
  .imgrow{display:flex;gap:8px;flex-wrap:wrap}
  /* .imgrow img{max-width:32%;height:auto;border:1px solid #30363d;border-radius:8px} 
  .imgrow .tile-thumb{position:relative; display:inline-block; cursor:pointer}
  .imgrow .tile-thumb img{max-width:32%; height:auto; border:1px solid #30363d; border-radius:8px}
  .imgrow .tile-thumb:hover img{outline:2px solid #58a6ff} */

  /* Detections cards */
  .det-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:10px}
  .det-card{background:var(--card);border:1px solid #30363d;border-radius:14px;padding:10px}
  .det-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .det-title{font-weight:700}
  .det-sub{color:var(--muted);font-size:12px}
  .det-badges{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
  .det-badge{background:var(--chip);border-radius:999px;padding:4px 8px;font-size:11px;color:var(--text)}
  .det-img{position:relative;height:300px;background:#0b0f16;border:1px solid #30363d;border-radius:12px;overflow:hidden;cursor:pointer}
  .det-one .det-img{height:420px;} /* quando c'√® solo 1 detection ‚Üí immagine pi√π grande */
  .det-img img{width:100%;height:100%;object-fit:contain}
  .det-meta{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px;margin-top:6px}

  /* modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9999}
  .modal.open{display:flex}
  .modal-box{background:#0b0f16;border:1px solid #30363d;color:var(--text);padding:10px;border-radius:12px;max-width:92vw;max-height:92vh;display:flex;flex-direction:column;gap:8px}
  .modal-img{max-width:88vw;max-height:72vh;object-fit:contain}
  .modal-top{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .btn{border:1px solid #30363d;background:var(--chip);color:var(--text);padding:6px 10px;border-radius:8px;cursor:pointer}

  /* Waterfall tab */
  .water-wrap{padding:12px}
  .water-iframe{width:100%;height:76vh;border:1px solid #30363d;border-radius:12px;background:#0b0f16}

  /* Per le thumbnails */
  /* Contenitore miniature: una sola riga */
  /* === Tiles: fix dimensioni e click area === */
  #tilesPreview{
    display:flex;
    flex-wrap:nowrap;                /* tutte e 3 in una riga */
    gap:10px;
    align-items:flex-start;
  }

  #tilesPreview .tile-thumb{
    flex:0 0 calc((100% - 20px)/3);  /* 3 colonne (2 gap = 20px) */
    max-width:calc((100% - 20px)/3);
    padding:0;
    margin:0;
    border:none;
  }

  /* STOPPA la vecchia regola .imgrow img{max-width:32%} */
  #tilesPreview .tile-thumb img{
    display:block;
    width:100% !important;
    max-width:none !important;
    height:auto;
    margin:0;
    border:1px solid #30363d;
    border-radius:8px;
  }

  /* Hover opzionale */
  #tilesPreview .tile-thumb:hover img{
    outline:2px solid #58a6ff;
  }

  /* (opzionale) su schermi piccoli fai wrapping in 2 per riga */
  @media (max-width: 900px){
    #tilesPreview{ flex-wrap:wrap; }
    #tilesPreview .tile-thumb{
      flex:0 0 calc((100% - 10px)/2);
      max-width:calc((100% - 10px)/2);
    }
  }



</style>
</head>
<body>
<header>
  <h1>üö¶ CRPC (Cognitive Radio Protocol Cracking) Dashboard</h1>
  <div>
    <span class="chip" id="now">--:--:--</span>
    <span class="chip">refresh <span id="refreshMs">2000</span> ms</span>
  </div>
</header>

<div class="tabbar">
  <button id="tabMainBtn" class="active">Main</button>
  <button id="tabDetBtn">Detections</button>
  <button id="tabWaterBtn">Waterfall</button>
</div>

<div id="tabMain" class="tab active">
  <div class="grid cols-3">
    <div class="card">
      <h2>üß© Servizi</h2>
      <div id="services"></div>
    </div>

    <div class="card">
      <h2>üíæ /tmp</h2>
      <div class="kpi">
        <div class="chip">Total: <span id="tmpTotal">-</span></div>
        <div class="chip">Used: <span id="tmpUsed">-</span></div>
        <div class="chip">Free: <span id="tmpFree">-</span></div>
        <div class="chip">Usage: <span id="tmpPct">-</span></div>
      </div>
      <div style="margin-top:8px">
        <canvas id="tmpSpark" class="spark"></canvas>
      </div>
    </div>

    <div class="card">
      <h2>üñºÔ∏è Tiles</h2>
      <div class="kpi">
        <div class="chip">In coda: <b id="tilesQueue">0</b></div>
        <div class="chip">Completate: <b id="tilesDone">0</b></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="grow">
          <div class="muted">Queue latest</div>
          <div id="tilesLatestQ" class="mono muted">‚Äî</div>
        </div>
        <div class="grow">
          <div class="muted">Done latest</div>
          <div id="tilesLatestD" class="mono muted">‚Äî</div>
        </div>
      </div>
      <div class="imgrow" id="tilesPreview"></div>
    </div>
  </div>

  <div class="grid cols-2">
    <div class="card">
      <h2>üéØ Detections (tail)</h2>
      <pre id="detTail" class="mono" style="white-space:pre-wrap;max-height:180px;overflow:auto">‚Äî</pre>
    </div>
    <div class="card">
      <h2>üìú Assoc log (tail)</h2>
      <pre id="assocLog" class="mono" style="white-space:pre-wrap;max-height:180px;overflow:auto">‚Äî</pre>
    </div>
  </div>

  <div class="grid cols-2">
    <div class="card">
      <h2>üß≠ Tracks current</h2>
      <table id="tracksTbl">
        <thead><tr><th>ID</th><th>Band</th><th>f (MHz)</th><th>bw</th><th>hop</th><th>len</th><th>seen</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="card">
      <h2>ü§ñ RFScan (fusion)</h2>
      <table id="rfTbl">
        <thead><tr><th>ID</th><th>Band</th><th>f (MHz)</th><th>bw</th><th>Family</th><th>Label</th><th>Score</th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:8px">
        <h3 class="muted" style="margin:0 0 6px 0">Breakdown per banda</h3>
        <table id="bandTbl">
          <thead><tr><th>Banda</th><th>Famiglia</th><th>Count</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="grid cols-2">
    <div class="card">
      <h2>üì° Sweep tails</h2>
      <div class="row">
        <div class="grow">
          <div class="muted">2.4 GHz</div>
          <pre id="s24" class="mono" style="white-space:pre-wrap;max-height:120px;overflow:auto"></pre>
        </div>
        <div class="grow">
          <div class="muted">5.8 GHz</div>
          <pre id="s58" class="mono" style="white-space:pre-wrap;max-height:120px;overflow:auto"></pre>
        </div>
      </div>
    </div>
    <div class="card">
      <h2>‚ö†Ô∏è Warnings (journal)</h2>
      <pre id="warnTail" class="mono" style="white-space:pre-wrap;max-height:120px;overflow:auto"></pre>
    </div>
  </div>
</div>

<div id="tabDet" class="tab">
  <div class="grid cols-3">
    <div class="card" style="grid-column:1/-1">
      <h2>üéØ Detections</h2>
      <div class="muted" id="detInfo">auto‚Äërefresh ogni 2s</div>
      <div class="det-grid" id="detGrid"></div>
    </div>
  </div>
</div>

<div id="tabWater" class="tab">
  <div class="water-wrap">
    <div class="card" style="padding:0">
      <iframe class="water-iframe" id="waterframe" src="about:blank" title="Waterfall"></iframe>
    </div>
  </div>
</div>

<!-- modal per preview tile -->
<div id="detModal" class="modal" role="dialog" aria-modal="true">
  <div class="modal-box">
    <div class="modal-top">
      <div id="detModalInfo" class="muted">‚Äî</div>
      <button class="btn" id="detModalClose">Chiudi ‚úï</button>
    </div>
    <img id="detModalImg" class="modal-img" src="" alt="preview">
  </div>
</div>

<script>
const REFRESH_MS = 2000;
const api = (p)=>fetch(p).then(r=>r.json());
const byId = (id)=>document.getElementById(id);
function bytes(v){ if(!v && v!==0) return "-"; const u=['B','KB','MB','GB']; let i=0; while(v>1024 && i<u.length-1){v/=1024;i++;} return v.toFixed( (i<2)?0:1 )+" "+u[i]; }
function pct(p){ return (p==null)?"-":(p.toFixed? p.toFixed(0):p)+"%"; }
function tsfmt(){ const d=new Date(); return d.toLocaleTimeString(); }

// tabs
const tabMainBtn = byId('tabMainBtn');
const tabDetBtn  = byId('tabDetBtn');
const tabWaterBtn= byId('tabWaterBtn');
const tabMain = byId('tabMain');
const tabDet  = byId('tabDet');
const tabWater= byId('tabWater');

tabMainBtn.onclick = ()=>{ [tabMainBtn,tabDetBtn,tabWaterBtn].forEach(b=>b.classList.remove('active')); tabMainBtn.classList.add('active'); [tabMain,tabDet,tabWater].forEach(x=>x.classList.remove('active')); tabMain.classList.add('active'); };
tabDetBtn.onclick  = ()=>{ [tabMainBtn,tabDetBtn,tabWaterBtn].forEach(b=>b.classList.remove('active')); tabDetBtn.classList.add('active');  [tabMain,tabDet,tabWater].forEach(x=>x.classList.remove('active')); tabDet.classList.add('active'); };
tabWaterBtn.onclick= ()=>{ [tabMainBtn,tabDetBtn,tabWaterBtn].forEach(b=>b.classList.remove('active')); tabWaterBtn.classList.add('active');[tabMain,tabDet,tabWater].forEach(x=>x.classList.remove('active')); tabWater.classList.add('active'); };

// Simple sparkline
const spark = {
  data: [], maxPoints: 60,
  push(v){ this.data.push(v); if(this.data.length>this.maxPoints) this.data.shift(); },
  draw(id){
    const c = byId(id); if(!c) return;
    const ctx = c.getContext('2d'); const W = c.width = c.clientWidth; const H = c.height = c.clientHeight;
    ctx.clearRect(0,0,W,H); if(this.data.length<2) return;
    const min = Math.min(...this.data), max = Math.max(...this.data);
    const xr = (i)=> i*(W/(this.data.length-1));
    const yr = (v)=> H - ((v-min)/(max-min||1))*H;
    ctx.beginPath();
    this.data.forEach((v,i)=>{ const x = xr(i), y = yr(v); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
    ctx.lineWidth = 2; ctx.strokeStyle = "#58a6ff"; ctx.stroke();
  }
};

function fmtLocal(ts){ if(!ts) return "‚Äî"; try { return new Date(ts*1000).toLocaleString(); } catch(e){ return "‚Äî"; } }

function renderBandBreakdown(obj){
  const tbody = byId('bandTbl').querySelector('tbody');
  tbody.innerHTML = '';
  const bands = Object.keys(obj||{});
  bands.forEach(b=>{
    const fams = obj[b] || {};
    Object.keys(fams).forEach(f=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${b}</td><td>${f}</td><td class="mono">${fams[f]}</td>`;
      tbody.appendChild(tr);
    });
  });
}

function renderPreviews(previews){
  const div = byId('tilesPreview');
  div.innerHTML = '';

  // Usa i nuovi campi con info; se mancano, fai fallback ai vecchi array
  const done = (previews?.done_info && previews.done_info.length)
      ? previews.done_info
      : (previews?.done||[]).map(name=>({name, url:'/api/file/'+encodeURIComponent(name), ts_unix:null}));

  const queue = (previews?.queue_info && previews.queue_info.length)
      ? previews.queue_info
      : (previews?.queue||[]).map(name=>({name, url:'/api/file/'+encodeURIComponent(name), ts_unix:null}));

  const imgs = [...done, ...queue].slice(0,3);

  imgs.forEach(o=>{
    const info = (o.ts_unix ? new Date(o.ts_unix*1000).toLocaleString()+' ¬∑ ' : '')
                 + (o.name || '');
    const wrap = document.createElement('div');
    wrap.className = 'tile-thumb';
    wrap.dataset.img = o.url;
    wrap.dataset.info = info;
    wrap.innerHTML = `<img loading="lazy" src="${o.url}" alt="${o.name||''}">`;
    wrap.addEventListener('click', ()=>{
      // riusa il modal delle detections
      const m = document.getElementById('detModal');
      document.getElementById('detModalImg').src = o.url;
      document.getElementById('detModalInfo').textContent = info;
      m.classList.add('open');
    });
    div.appendChild(wrap);
  });
}

function renderConfMatrix(evalObj){
  const info = byId('evalInfo');
  const head = byId('cmHead');
  const body = byId('cmBody');
  const prBody = byId('prTbl')?.querySelector('tbody');
  if(info){ info.textContent = ''; head.innerHTML=''; body.innerHTML=''; if(prBody) prBody.innerHTML=''; }
  if(!info || !evalObj?.available){
    if(info) info.textContent = 'Ground truth non configurata (CRPC_GT_CSV).';
    return;
  }
  info.textContent = `samples=${evalObj.n_samples} | accuracy=${(evalObj.accuracy*100).toFixed(1)}%`;
  const labels = evalObj.labels || [];
  const trh = document.createElement('tr');
  trh.innerHTML = '<th>True \\ Pred</th>' + labels.map(l=>`<th>${l}</th>`).join('');
  head.appendChild(trh);
  labels.forEach(t=>{
    const tr = document.createElement('tr');
    const cells = [ `<td>${t}</td>` ];
    labels.forEach(p=> cells.push(`<td class="mono">${evalObj.confusion_matrix[t][p]}</td>`));
    tr.innerHTML = cells.join('');
    body.appendChild(tr);
  });
  if(prBody){
    labels.forEach(l=>{
      const tr = document.createElement('tr');
      const pr = evalObj.precision[l] ?? 0, rc = evalObj.recall[l] ?? 0, sup = evalObj.support[l] ?? 0;
      tr.innerHTML = `<td>${l}</td><td class="mono">${(pr*100).toFixed(1)}%</td><td class="mono">${(rc*100).toFixed(1)}%</td><td class="mono">${sup}</td>`;
      prBody.appendChild(tr);
    });
  }
}

async function tick(){
  try{
    const j = await api('/api/status');
    byId('now').textContent = tsfmt();

    // services
    const sDiv = byId('services'); sDiv.innerHTML = '';
    Object.entries(j.services||{}).forEach(([name,state])=>{
      const color = state==='active' ? 'ok' : (state==='failed' || state==='inactive' ? 'bad' : 'warn');
      const el = document.createElement('div');
      el.className = 'svc';
      el.innerHTML = `<div class="mono">${name}</div><div class="state ${color}">${state}</div>`;
      sDiv.appendChild(el);
    });

    // /tmp
    if(j.tmp_usage){
      byId('tmpTotal').textContent = bytes(j.tmp_usage.total);
      byId('tmpUsed').textContent  = bytes(j.tmp_usage.used);
      byId('tmpFree').textContent  = bytes(j.tmp_usage.free);
      byId('tmpPct').textContent   = pct(j.tmp_usage.percent);
      spark.push(j.tmp_usage.percent||0); spark.draw('tmpSpark');
    }

    // tiles
    byId('tilesQueue').textContent = j.tiles?.queue ?? '-';
    byId('tilesDone').textContent  = j.tiles?.done ?? '-';
    byId('tilesLatestQ').textContent = (j.tiles?.latest_queue||[]).join('\n') || '‚Äî';
    byId('tilesLatestD').textContent = (j.tiles?.latest_done||[]).join('\n') || '‚Äî';
    renderPreviews(j.previews);

    // logs tails
    byId('detTail').textContent = (j.logs?.detections_tail||[]).join('\n') || '‚Äî';
    byId('assocLog').textContent = (j.logs?.assoc_log_tail||[]).join('\n') || '‚Äî';
    byId('warnTail').textContent = (j.logs?.warnings_tail||[]).join('\n') || '‚Äî';

    // sweeps
    byId('s24').textContent = (j.sweeps?.["24"]||[]).join('\n') || '‚Äî';
    byId('s58').textContent = (j.sweeps?.["58"]||[]).join('\n') || '‚Äî';

    // tracks table
    const tBody = document.querySelector('#tracksTbl tbody'); tBody.innerHTML = '';
    (j.tracks_current||[]).forEach(o=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="mono">${o.track_id}</td>
        <td>${o.band}</td>
        <td class="mono">${(o.center_freq_mhz??0).toFixed(3)}</td>
        <td class="mono">${(o.bandwidth_mhz??0).toFixed(3)}</td>
        <td class="mono">${(o.hop_rate_mhz_s??0).toFixed(3)}</td>
        <td class="mono">${o.len}</td>
        <td class="mono">${(o.last_seen??0).toFixed(1)}</td>`;
      tBody.appendChild(tr);
    });

    // rfscan table
    const rBody = document.querySelector('#rfTbl tbody'); rBody.innerHTML = '';
    (j.rfscan_current||[]).forEach(o=>{
      const tr = document.createElement('tr');
      const fam = o.family || '';
      const famCls = fam==='DJI'?'ok': (fam==='FrSky'||fam==='FlySky'?'warn':'')
      tr.innerHTML = `<td class="mono">${o.track_id}</td>
        <td>${o.band||''}</td>
        <td class="mono">${( o.center_freq_mhz ?? (o.freq ? o.freq/1e6 : 0) ).toFixed(3)}</td>
        <td class="mono">${(o.bandwidth_mhz??0).toFixed(3)}</td>
        <td class="${famCls}">${fam}</td>
        <td class="mono">${o.label||''}</td>
        <td class="mono">${(o.score??0).toFixed(2)}</td>`;
      rBody.appendChild(tr);
    });

    renderBandBreakdown(j.breakdown_by_band);
    renderConfMatrix(j.eval);

  }catch(e){ console.error(e); }
  finally{ setTimeout(tick, REFRESH_MS); }
}

// --- Detections UI ---
const detGrid = document.getElementById('detGrid');
const detInfo = document.getElementById('detInfo');
const detModal = document.getElementById('detModal');
const detModalImg = document.getElementById('detModalImg');
const detModalInfo = document.getElementById('detModalInfo');
document.getElementById('detModalClose').onclick = ()=> detModal.classList.remove('open');
detModal.addEventListener('click', (e)=>{ if(e.target===detModal) detModal.classList.remove('open'); });
window.addEventListener('keydown', e=>{ if(e.key==='Escape') detModal.classList.remove('open'); });

function fmtMHz(v){ if(v==null) return "‚Äî"; try{return parseFloat(v).toFixed(3)+" MHz";}catch(e){return v+" MHz";} }

function detCardHTML(d){
  const badges = (d.badges||[]).map(b=>`<span class="det-badge">${b}</span>`).join('');
  const img = d.thumbnail
    ? `<div class="det-img" data-img="${d.thumbnail}" data-info="${fmtMHz(d.freq_mhz)} ¬∑ band ${d.band??'UNK'}"><img loading="lazy" src="${d.thumbnail}"></div>`
    : `<div class="det-img"><div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted)">no preview</div></div>`;
  const bw = d.bw_mhz ? ` ¬∑ BW ${d.bw_mhz}` : "";
  const snr = (d.snr_db!=null) ? ` ¬∑ SNR ${d.snr_db}dB` : "";
  return `
  <div class="det-card">
    <div class="det-hdr">
      <div class="det-title">Drone detected</div>
      <div class="det-sub">${d.ts_unix ? fmtLocal(d.ts_unix) : '‚Äî'}</div>
    </div>
    <div class="det-sub" style="margin-bottom:6px">${fmtMHz(d.freq_mhz)} ¬∑ band ${d.band ?? 'UNK'}</div>
    <div class="det-badges">${badges}</div>
    ${img}
    <div class="det-meta"><div>${(d.src||'rfscan').toUpperCase()}</div><div>${bw}</div><div>${snr}</div></div>
  </div>`;
}

function wireDetClicks(){
  detGrid.querySelectorAll('.det-img[data-img]').forEach(div=>{
    div.addEventListener('click', ()=>{
      detModalImg.src = div.dataset.img;
      detModalInfo.textContent = div.dataset.info || '';
      detModal.classList.add('open');
    });
  });
}

async function refreshDetections(){
  try{
    const r = await api('/api/detections');
    const arr = r.detections || [];
    detGrid.innerHTML = arr.map(detCardHTML).join('');
    if ((arr||[]).length === 1) detGrid.classList.add('det-one'); else detGrid.classList.remove('det-one');
    wireDetClicks();
    detInfo.textContent = `auto‚Äërefresh ogni 2s ¬∑ ${arr.length} elementi`;
  }catch(e){ detInfo.textContent = 'errore caricamento /api/detections'; }
}

function fmtLocal(ts){ if(!ts) return '‚Äî'; try { return new Date(ts*1000).toLocaleString(); } catch(e){ return '‚Äî'; } }

document.getElementById('refreshMs').textContent = REFRESH_MS;
tick();
refreshDetections();
setInterval(refreshDetections, REFRESH_MS);
// inizializza iframe Waterfall puntando all'host corrente su porta 8081
(function(){
  const host = location.hostname; // es. 192.168.1.5
  const url = location.protocol + '//' + host + ':8081/';
  const f = document.getElementById('waterframe');
  if(f) f.src = url;
})();
</script>
</body>
</html>
